<view class="container">
  <van-search placeholder="搜索闲置物品/帖子" shape="round" background="#f7f8fa" />
  
  <van-tabs active="{{ active }}" color="#07c160" sticky bind:change="onTabChange">
    <!-- Tab 1: Second-hand Market -->
    <van-tab title="二手闲置">
      <view class="p-30">
        <block wx:for="{{ marketItems }}" wx:key="id">
          <view class="community-card" bind:tap="onMarketItemClick" data-id="{{item.id}}">
            <view class="user-row">
              <image class="avatar-small" src="{{item.avatar}}"></image>
              <text class="username">{{item.user}}</text>
              <text class="time">{{item.time}}</text>
            </view>
            <view class="content">
              <text class="title">{{item.title}}</text>
              <image wx:if="{{item.image}}" class="post-image" mode="aspectFill" src="{{item.image}}"></image>
              <view class="price-row" wx:if="{{item.price}}">
                 <text class="price">¥ {{item.price}}</text>
              </view>
            </view>
            <view class="actions">
               <van-button size="mini" icon="chat-o" catch:tap="onChatClick">私聊</van-button>
            </view>
          </view>
        </block>
      </view>
    </van-tab>

    <!-- Tab 2: Neighborhood Help -->
    <van-tab title="邻居互助">
      <view class="p-30">
        <block wx:for="{{ helpPosts }}" wx:key="id">
          <view class="community-card" bind:tap="onHelpClick" data-id="{{item.id}}">
            <view class="user-row">
              <image wx:if="{{item.publisher.avatar}}" class="avatar-small" src="{{item.publisher.avatar}}"></image>
              <view wx:else class="avatar-placeholder">{{item.publisher.display_name.charAt(0) || item.publisher.nickname.charAt(0)}}</view>
              <text class="username">{{item.publisher.display_name || item.publisher.nickname}}</text>
              <text class="time">{{item.time_ago}}</text>
            </view>
            <view class="content">
              <text class="title">{{item.title || item.content}}</text>
            </view>
            <view class="tags" wx:if="{{item.tag}}">
              <van-tag type="{{item.tag === '急' ? 'danger' : 'primary'}}">{{item.tag}}</van-tag>
              <van-tag wx:if="{{item.is_urgent}}" type="warning">紧急</van-tag>
              <van-tag wx:if="{{item.is_resolved}}" type="success">已解决</van-tag>
            </view>
            <view class="meta-info">
              <text class="meta-text">浏览 {{item.view_count}} · 回复 {{item.response_count}}</text>
            </view>
            <view class="actions">
              <van-button size="mini" type="primary" catch:tap="onHelpButtonClick" data-id="{{item.id}}" disabled="{{item.is_resolved}}">
                {{item.is_resolved ? '已解决' : '我来帮'}}
              </van-button>
            </view>
          </view>
        </block>
        
        <!-- 空状态 -->
        <view wx:if="{{helpPosts.length === 0 && !loading}}" class="empty-state">
          <van-empty description="暂无求助信息" />
        </view>
        
        <!-- 加载状态 -->
        <van-loading wx:if="{{loading}}" type="spinner" color="#07c160">加载中...</van-loading>
      </view>
    </van-tab>

    <!-- Tab 3: Community Events -->
    <van-tab title="社区活动">
       <view class="p-30">
         <block wx:for="{{ activities }}" wx:key="id">
           <view class="event-card" bind:tap="onEventClick" data-id="{{item.id}}">
             <image class="event-banner" src="{{item.banner}}" mode="aspectFill"></image>
             <view class="event-info">
               <text class="event-title">{{item.title}}</text>
               <text class="event-time">时间：{{item.time_display}}</text>
               <text class="event-loc">地点：{{item.location}}</text>
               
               <!-- 活动状态和报名进度 -->
               <view class="event-status">
                 <van-tag type="{{item.status_color}}" size="small">{{item.status_text}}</van-tag>
                 <text class="participants-count">{{item.current_participants}}/{{item.max_participants}}人</text>
               </view>
               
               <!-- 报名进度条 -->
               <van-progress 
                 percentage="{{item.registration_progress}}" 
                 stroke-width="4" 
                 color="#07c160" 
                 inactive-color="#f2f3f5"
                 show-pivot="{{false}}"
               />
               
               <!-- 报名按钮 -->
               <van-button 
                 block 
                 color="#07c160" 
                 round 
                 size="small" 
                 custom-class="mt-20"
                 disabled="{{!item.can_register || item.user_registered}}"
                 catch:tap="onEventEnrollClick" 
                 data-id="{{item.id}}"
               >
                 {{item.user_registered ? '已报名' : (item.can_register ? '立即报名' : '暂不可报名')}}
               </van-button>
             </view>
           </view>
         </block>
         
         <!-- 空状态 -->
         <view wx:if="{{activities.length === 0 && !loading}}" class="empty-state">
           <van-empty description="暂无社区活动" />
         </view>
         
         <!-- 加载状态 -->
         <van-loading wx:if="{{loading}}" type="spinner" color="#07c160">加载中...</van-loading>
       </view>
    </van-tab>
  </van-tabs>
  
  <!-- Floating Action Button for Posting -->
  <view class="fab-btn" bind:tap="onPostClick">
    <van-icon name="plus" size="30px" color="#fff" />
  </view>
</view>
