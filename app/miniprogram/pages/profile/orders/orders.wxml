<view class="container">
  <!-- 加载状态 -->
  <van-loading wx:if="{{loading && orders.length === 0}}" type="spinner" color="#07c160" vertical class="loading">
    加载中...
  </van-loading>

  <!-- 错误状态 -->
  <van-empty wx:elif="{{error}}" image="error" description="{{error}}">
    <van-button round type="primary" class="bottom-button" bind:click="refreshOrders">重新加载</van-button>
  </van-empty>

  <!-- 正常内容 -->
  <view wx:else>
    <van-tabs active="{{activeTab}}" color="#07c160" bind:change="onTabChange">
      <van-tab title="全部"></van-tab>
      <van-tab title="待接单"></van-tab>
      <van-tab title="进行中"></van-tab>
      <van-tab title="已完成"></van-tab>
      <van-tab title="已取消"></van-tab>
    </van-tabs>

    <view class="order-list">
      <block wx:for="{{orders}}" wx:key="id">
        <view class="order-card">
          <view class="order-header">
            <view class="order-info">
              <text class="merchant-name">{{item.merchant_name}}</text>
              <text class="order-no">订单号：{{item.order_no}}</text>
            </view>
            <van-tag type="{{item.status === 'completed' ? 'success' : item.status === 'cancelled' ? 'danger' : 'primary'}}">
              {{item.status_display}}
            </van-tag>
          </view>

          <!-- 订单商品列表 -->
          <view class="order-items">
            <block wx:for="{{item.items}}" wx:for-item="orderItem" wx:key="id">
              <view class="order-item">
                <text class="item-name">{{orderItem.product_name}}</text>
                <text class="item-price">¥{{orderItem.product_price}} x {{orderItem.quantity}}</text>
              </view>
            </block>
          </view>

          <!-- 订单信息 -->
          <view class="order-details">
            <view class="detail-row" wx:if="{{item.pickup_code}}">
              <text class="detail-label">取餐码：</text>
              <text class="detail-value highlight">{{item.pickup_code}}</text>
            </view>
            <view class="detail-row" wx:if="{{item.pickup_type_display}}">
              <text class="detail-label">取餐方式：</text>
              <text class="detail-value">{{item.pickup_type_display}}</text>
            </view>
            <view class="detail-row">
              <text class="detail-label">下单时间：</text>
              <text class="detail-value">{{item.created_at}}</text>
            </view>
            <view class="detail-row" wx:if="{{item.discount_amount > 0}}">
              <text class="detail-label">优惠金额：</text>
              <text class="detail-value discount">-¥{{item.discount_amount}}</text>
            </view>
          </view>

          <view class="order-footer">
            <view class="price-info">
              <text class="total-label">合计：</text>
              <text class="total-amount">¥{{item.actual_amount}}</text>
              <text class="original-amount" wx:if="{{item.discount_amount > 0}}">¥{{item.total_amount}}</text>
            </view>
            <view class="action-buttons">
              <van-button size="mini" round plain bind:tap="onContactMerchant"
                         wx:if="{{item.status !== 'cancelled'}}">
                联系
              </van-button>
              <van-button size="mini" round type="danger" plain bind:tap="onCancelOrder"
                         data-id="{{item.id}}"
                         wx:if="{{item.status === 'new'}}">
                取消
              </van-button>
            </view>
          </view>
        </view>
      </block>

      <!-- 加载更多 -->
      <view class="load-more" wx:if="{{loading && orders.length > 0}}">
        <van-loading type="spinner" size="20">加载中...</van-loading>
      </view>

      <!-- 没有更多数据 -->
      <view class="no-more" wx:elif="{{!hasMore && orders.length > 0}}">
        <van-divider>没有更多了</van-divider>
      </view>

      <!-- 空状态 -->
      <van-empty wx:elif="{{orders.length === 0}}" image="search" description="暂无订单">
        <van-button round type="primary" class="bottom-button" url="/pages/services/services">
          去下单
        </van-button>
      </van-empty>
    </view>
  </view>
</view>
